<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>日本語形態素解析・頻度集計（ログイン不要）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="./vendor/kuromoji.js"></script>
  <style>
    .mono { font-feature-settings: "palt"; }
    .spinner { border: 4px solid #e5e7eb; border-top: 4px solid #9ca3af; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-5xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">日本語形態素解析・頻度集計（ブラウザ完結）2</h1>
      <a href="https://unpkg.com/kuromoji@0.1.2/" target="_blank" class="text-sm text-blue-600 underline">kuromoji.js</a>
    </header>

    <!-- エラー表示用バナー -->
    <div id="appError" class="hidden mt-3 p-3 rounded-xl bg-red-50 text-red-700 text-sm"></div>

    <section class="bg-white shadow rounded-2xl p-5 space-y-3">
      <p class="text-sm text-gray-600">テキストを貼り付けて「解析」ボタンを押すだけ。<b>ログイン不要・インストール不要・端末内で完結</b>します。</p>
      <div class="grid gap-3">
        <textarea id="inputText" class="w-full h-40 p-3 border rounded-xl focus:outline-none focus:ring" placeholder="自由記述をここに貼り付け…（複数行OK）"></textarea>
        <div class="flex flex-wrap gap-3 items-center">
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" id="keepStopwords" class="rounded" />
            助詞・助動詞なども集計に含める
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" id="useLemma" class="rounded" checked />
            原形で集計（例：行く/行った→行く）
          </label>
          <button id="analyzeBtn" onclick="window.__manualRun && window.__manualRun()" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-60">解析</button>
          <div id="loading" class="hidden items-center gap-2 text-sm text-gray-600"><div class="spinner"></div> 解析中…</div>
        </div>
      </div>
    </section>

    <section class="bg-white shadow rounded-2xl p-5 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">頻度上位</h2>
        <div class="flex gap-2">
          <button id="downloadCsv" class="px-3 py-1.5 rounded-lg border hover:bg-gray-50">CSVをダウンロード</button>
          <button id="copyTable" class="px-3 py-1.5 rounded-lg border hover:bg-gray-50">表をコピー</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="resultTable">
          <thead>
            <tr class="bg-gray-100">
              <th class="text-left p-2">語</th>
              <th class="text-left p-2">品詞</th>
              <th class="text-right p-2">頻度</th>
              <th class="text-left p-2">読み</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="bg-white shadow rounded-2xl p-5 space-y-3">
      <h2 class="font-semibold">2軸分類に使うには</h2>
      <ol class="list-decimal list-inside text-sm space-y-1 text-gray-700">
        <li>上の「CSVをダウンロード」で語頻度表を保存</li>
        <li>Googleスプレッドシートにインポート</li>
        <li>各語に <b>X軸/Y軸スコア</b>（1〜5など）を付ける列を追加</li>
        <li>挿入→チャート→散布図で2軸マップを作成</li>
      </ol>
    </section>

    <!-- 辞書ファイル存在チェック -->
    <section class="bg-white shadow rounded-2xl p-5 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">辞書ファイルの存在チェック（/dict/）</h2>
        <div class="flex gap-2 items-center">
          <button id="checkDictBtn" class="px-3 py-1.5 rounded-lg border hover:bg-gray-50">チェックを実行</button>
          <div id="dictLoading" class="hidden items-center gap-2 text-sm text-gray-600"><div class="spinner"></div> 確認中…</div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="dictCheckTable">
          <thead>
            <tr class="bg-gray-100">
              <th class="text-left p-2">ファイル名</th>
              <th class="text-left p-2">URL</th>
              <th class="text-left p-2">HTTP</th>
              <th class="text-left p-2">サイズ</th>
              <th class="text-left p-2">結果</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="dictSummary" class="text-sm text-gray-700"></div>
    </section>

    <footer class="text-xs text-gray-500">© 授業・探究活動でご自由にお使いください（学内配布可）。</footer>
  </div>

  <script>
    let tokenizer = null;
    const dictPath = "./dict/";

    function buildTokenizer(timeoutMs = 15000) {
      return new Promise((resolve, reject) => {
        if (tokenizer) return resolve(tokenizer);
        let settled = false;
        const to = setTimeout(()=>{
          if (!settled){ settled = true; reject(new Error('辞書の読み込みがタイムアウトしました。dict フォルダの配置とパスを確認してください。')); }
        }, timeoutMs);
        kuromoji.builder({ dicPath: dictPath }).build(function(err, t) {
          if (settled) return;
          clearTimeout(to);
          if (err){ settled = true; return reject(err); }
          tokenizer = t; settled = true; resolve(tokenizer);
        });
      });
    }

    function analyze(text, { keepStopwords=false, useLemma=true } = {}) {
      if (!tokenizer) throw new Error("Tokenizer not ready");
      const tokens = tokenizer.tokenize(text || "");
      const counter = new Map();
      for (const tk of tokens) {
        const pos = tk.pos;
        const isStop = (pos === "助詞" || pos === "助動詞" || pos === "記号" || pos === "補助記号" || pos === "連体詞");
        if (!keepStopwords && isStop) continue;
        const base = (useLemma && tk.basic_form && tk.basic_form !== "*") ? tk.basic_form : tk.surface_form;
        const key = base;
        const item = counter.get(key) || { surface: base, pos, yomi: tk.reading || "", freq: 0 };
        item.freq += 1;
        if (item.pos !== pos && (pos === "名詞" || pos === "動詞" || pos === "形容詞")) item.pos = pos;
        if (!item.yomi && tk.reading) item.yomi = tk.reading;
        counter.set(key, item);
      }
      return Array.from(counter.values()).sort((a,b)=> b.freq - a.freq || a.surface.localeCompare(b.surface, 'ja'));
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = '';
      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2">${escapeHtml(r.surface)}</td>
          <td class="p-2">${escapeHtml(r.pos || '')}</td>
          <td class="p-2 text-right">${r.freq}</td>
          <td class="p-2">${escapeHtml(r.yomi || '')}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[m]));
    }

    function toCsv(rows){
      const header = ['token','pos','freq','reading'];
      const lines = [header.join(',')];
      for (const r of rows) {
        const cols = [r.surface, r.pos || '', r.freq, r.yomi || ''].map(v => {
          const s = String(v ?? '');
          return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
        });
        lines.push(cols.join(','));
      }
      return lines.join('\n');
    }

    function download(filename, text){
      const blob = new Blob([text], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    async function run(){
      const btn = document.getElementById('analyzeBtn');
      const loading = document.getElementById('loading');
      btn.disabled = true; loading.classList.remove('hidden');
      try {
        await buildTokenizer();
        const text = document.getElementById('inputText').value;
        const keep = document.getElementById('keepStopwords').checked;
        const lemma = document.getElementById('useLemma').checked;
        const rows = analyze(text, { keepStopwords: keep, useLemma: lemma });
        renderTable(rows);
        window.__rows = rows;
      } catch (e) {
        alert('解析でエラーが発生しました: ' + (e && e.message ? e.message : e));
        console.error(e);
      } finally {
        btn.disabled = false; loading.classList.add('hidden');
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      try {
        const analyzeBtn = document.getElementById('analyzeBtn');
        const downloadBtn = document.getElementById('downloadCsv');
        const copyBtn = document.getElementById('copyTable');
        const checkBtn = document.getElementById('checkDictBtn');
        if (!analyzeBtn) throw new Error('#analyzeBtn not found');
        analyzeBtn.addEventListener('click', run);
        if (downloadBtn) downloadBtn.addEventListener('click', () => {
          const rows = window.__rows || [];
          if (!rows.length) return alert('まだ結果がありません。先に「解析」を実行してください。');
          download('tokens_frequency.csv', toCsv(rows));
        });
        if (copyBtn) copyBtn.addEventListener('click', async () => {
          try {
            const rows = window.__rows || [];
            if (!rows.length) return alert('まだ結果がありません。先に「解析」を実行してください。');
        
            const tsvLines = ['token\tpos\tfreq\treading'].concat(
              rows.map(r => [r.surface, r.pos || '', r.freq, r.yomi || ''].join('\t'))
            );
            await navigator.clipboard.writeText(tsvLines.join('\n'));
            alert('表データをコピーしました（TSV）。スプレッドシートに貼り付けできます。');
          } catch (e) {
            alert('コピーに失敗しました。');
            console.error(e);
          }
        });
        if (checkBtn) checkBtn.addEventListener('click', () => { if (typeof checkDict === 'function') checkDict(); else alert('checkDict 関数が定義されていません'); });
      } catch (err){
        const box = document.getElementById('appError');
        if (box){ box.textContent = '初期化エラー: ' + err.message; box.classList.remove('hidden'); }
        console.error(err);
      }
    });
    
  // ---- 辞書ファイル存在チェック機能 ----
    const EXPECTED_DICT = [
      'base.dat.gz','cc.dat.gz','check.dat.gz','tid.dat.gz','tid_map.dat.gz','tid_pos.dat.gz',
      'unk.dat.gz','unk_char.dat.gz','unk_compat.dat.gz','unk_invoke.dat.gz','unk_map.dat.gz','unk_pos.dat.gz'
    ];

    function clearDictTable(){
      const tbody = document.querySelector('#dictCheckTable tbody');
      if (tbody) tbody.innerHTML = '';
      const summary = document.getElementById('dictSummary');
      if (summary) summary.textContent = '';
    }

    function addDictRow({name, url, status, size, ok}){
      const tbody = document.querySelector('#dictCheckTable tbody');
      if (!tbody) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-2">${escapeHtml(name)}</td>
        <td class="p-2"><a class="text-blue-600 underline" href="${url}" target="_blank">${escapeHtml(url)}</a></td>
        <td class="p-2">${status}</td>
        <td class="p-2">${size ?? ''}</td>
        <td class="p-2 ${ok ? 'text-green-700' : 'text-red-700'}">${ok ? 'OK' : 'NG'}</td>
      `;
      tbody.appendChild(tr);
    }

    async function headOrGet(url){
      try {
        const res = await fetch(url, { method: 'GET', cache: 'no-store' });
        const len = res.headers.get('content-length');
        return { ok: res.ok, status: res.status, size: len };
      } catch (e){
        return { ok: false, status: 'ERR', size: '' };
      }
    }

    window.checkDict = async function (){
      clearDictTable();
      const loading = document.getElementById('dictLoading');
      if (loading) loading.classList.remove('hidden');

      const dictBase = typeof dictPath === 'string' ? dictPath : './dict/';
      let okCount = 0;

      for (const name of EXPECTED_DICT){
        const url = dictBase + name;
        const r = await headOrGet(url);
        if (r.ok) okCount++;
        addDictRow({ name, url, status: r.status, size: r.size, ok: r.ok });
      }

      if (loading) loading.classList.add('hidden');

      const summary = document.getElementById('dictSummary');
      if (!summary) return;
      if (okCount === EXPECTED_DICT.length){
        summary.innerHTML = `✅ すべての辞書ファイル（${okCount}/${EXPECTED_DICT.length}）が見つかりました。`;
      } else {
        summary.innerHTML = `⚠️ 見つからない辞書があります（${okCount}/${EXPECTED_DICT.length}）。パスやファイル名、配置を確認してください。`;
      }
    };
    window.__manualRun = run;
  </script>
</body>
</html>
